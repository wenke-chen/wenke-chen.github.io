<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='记录从0到1学习平衡车的过程'>
<title>基于无刷电机的平衡小车</title>

<link rel='canonical' href='https://www.wenke-chen.github.io/p/segway/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='基于无刷电机的平衡小车'>
<meta property='og:description' content='记录从0到1学习平衡车的过程'>
<meta property='og:url' content='https://www.wenke-chen.github.io/p/segway/'>
<meta property='og:site_name' content='wenke-chen&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='平衡小车' /><meta property='article:tag' content='无刷电机' /><meta property='article:tag' content='机器人' /><meta property='article:tag' content='STM32' /><meta property='article:published_time' content='2025-07-11T22:47:51&#43;08:00'/><meta property='article:modified_time' content='2025-07-11T22:47:51&#43;08:00'/><meta property='og:image' content='https://www.wenke-chen.github.io/p/segway/car.png' />
<meta name="twitter:title" content="基于无刷电机的平衡小车">
<meta name="twitter:description" content="记录从0到1学习平衡车的过程"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://www.wenke-chen.github.io/p/segway/car.png' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/learn_dog_hu42490b1a39612587b65eb91d2414c2d9_387376_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">wenke-chen&#39;s blog</a></h1>
            <h2 class="site-description">学如逆水行舟，不进则退。</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://www.wenke-chen.github.io/" selected></option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#一物料清单">一、物料清单</a></li>
    <li><a href="#二电气接线图">二、电气接线图</a></li>
    <li><a href="#三相关算法理论">三、相关算法理论</a>
      <ol>
        <li><a href="#1电机转动">1、电机转动</a></li>
        <li><a href="#2小车直立">2、小车直立</a>
          <ol>
            <li><a href="#lqr和pid控制算法的对比">LQR和PID控制算法的对比</a></li>
            <li><a href="#lqr数学模型">LQR数学模型</a></li>
            <li><a href="#lqr控制器">LQR控制器</a></li>
            <li><a href="#仿真">仿真</a></li>
            <li><a href="#参考资料">参考资料</a></li>
            <li><a href="#实物部署">实物部署</a></li>
          </ol>
        </li>
        <li><a href="#3小车遥控">3、小车遥控</a></li>
      </ol>
    </li>
    <li><a href="#四调试心得">四、调试心得</a></li>
    <li><a href="#五实物展示">五、实物展示</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/segway/">
                <img src="/p/segway/car_huedaa8f5f72a7c1929b4fa5b365acec86_54738_800x0_resize_box_3.png"
                        srcset="/p/segway/car_huedaa8f5f72a7c1929b4fa5b365acec86_54738_800x0_resize_box_3.png 800w, /p/segway/car_huedaa8f5f72a7c1929b4fa5b365acec86_54738_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="316" 
                        loading="lazy"
                        alt="Featured image of post 基于无刷电机的平衡小车" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%AD%A6%E4%B9%A0/" >
                学习
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/segway/">基于无刷电机的平衡小车</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            记录从0到1学习平衡车的过程
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jul 11, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    12 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="一物料清单">一、物料清单</h2>
<div align="center">  
<img src="物料清单.png" width="600"/> 
</div>
<p>物料清单包含所用到的电子件、机械件和3D打印件，并对额外的工具作了说明，本次电机和stm32开发板用的是同一个<a class="link" href="https://gitee.com/kit-miao/damiao"  target="_blank" rel="noopener"
    >厂家的产品</a>，电机自带驱动，省去了自写FOC算法，只需熟悉电机通信协议即可对电机有较好的控制，且厂家自带的范例已能应付很多场景。</p>
<h2 id="二电气接线图">二、电气接线图</h2>
<div align="center">  
<img src="电气接线图.png" width="700"/> 
</div>
<p>电机要先配好ID,esp32开发板要先刷好程序再开始组装。</p>
<h2 id="三相关算法理论">三、相关算法理论</h2>
<p>首先要确定我们要实现功能的先后顺序，即电机转动&ndash;&gt;小车直立&ndash;&gt;小车遥控。</p>
<div align="center">  
<img src="流程图.png" width="700"/> 
</div>
<h3 id="1电机转动">1、电机转动</h3>
<p><strong>本次用的直立算法是LQR,输出的是力矩，所以用电机的MIT模式。</strong></p>
<div align="center">  
<img src="MIT模式下控制帧.png" width="600"/> 
</div>
<p><strong>根据通信协议，我们查看厂家给的CAN控制函数范例。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/**
</span></span><span class="line"><span class="cl">************************************************************************
</span></span><span class="line"><span class="cl">* @brief:      	mit_ctrl: MIT模式下的电机控制函数
</span></span><span class="line"><span class="cl">* @param[in]:   hcan:			指向CAN_HandleTypeDef结构的指针，用于指定CAN总线
</span></span><span class="line"><span class="cl">* @param[in]:   motor_id:	电机ID，指定目标电机
</span></span><span class="line"><span class="cl">* @param[in]:   pos:			位置给定值
</span></span><span class="line"><span class="cl">* @param[in]:   vel:			速度给定值
</span></span><span class="line"><span class="cl">* @param[in]:   kp:				位置比例系数
</span></span><span class="line"><span class="cl">* @param[in]:   kd:				位置微分系数
</span></span><span class="line"><span class="cl">* @param[in]:   torq:			转矩给定值
</span></span><span class="line"><span class="cl">* @retval:     	void
</span></span><span class="line"><span class="cl">* @details:    	通过CAN总线向电机发送MIT模式下的控制帧。
</span></span><span class="line"><span class="cl">************************************************************************
</span></span><span class="line"><span class="cl">**/
</span></span><span class="line"><span class="cl">void mit_ctrl(hcan_t* hcan, uint16_t motor_id, float pos, float vel,float kp, float kd, float torq)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	uint8_t data[8];
</span></span><span class="line"><span class="cl">	uint16_t pos_tmp,vel_tmp,kp_tmp,kd_tmp,tor_tmp;
</span></span><span class="line"><span class="cl">	uint16_t id = motor_id + MIT_MODE;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	pos_tmp = float_to_uint(pos,  P_MIN,  P_MAX,  16);
</span></span><span class="line"><span class="cl">	vel_tmp = float_to_uint(vel,  V_MIN,  V_MAX,  12);
</span></span><span class="line"><span class="cl">	kp_tmp  = float_to_uint(kp,   KP_MIN, KP_MAX, 12);
</span></span><span class="line"><span class="cl">	kd_tmp  = float_to_uint(kd,   KD_MIN, KD_MAX, 12);
</span></span><span class="line"><span class="cl">	tor_tmp = float_to_uint(torq, T_MIN,  T_MAX,  12);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	data[0] = (pos_tmp &gt;&gt; 8);
</span></span><span class="line"><span class="cl">	data[1] = pos_tmp;
</span></span><span class="line"><span class="cl">	data[2] = (vel_tmp &gt;&gt; 4);
</span></span><span class="line"><span class="cl">	data[3] = ((vel_tmp&amp;0xF)&lt;&lt;4)|(kp_tmp&gt;&gt;8);
</span></span><span class="line"><span class="cl">	data[4] = kp_tmp;
</span></span><span class="line"><span class="cl">	data[5] = (kd_tmp &gt;&gt; 4);
</span></span><span class="line"><span class="cl">	data[6] = ((kd_tmp&amp;0xF)&lt;&lt;4)|(tor_tmp&gt;&gt;8);
</span></span><span class="line"><span class="cl">	data[7] = tor_tmp;
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	canx_send_data(hcan, id, data, 8);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>*MIT命令采用浮点数据等比例转换成整数发送到驱动器，驱动器再将接收到的整数等比例转换成浮点数据。这转换需要用到转换函数float_to_uint，这转换函数需要首先确定两个等比例转换的最大最小值，这两个值可以在上位参数设定页面查询，其中 KP、KD 的最大最小值默认分别为 0.0~500.0、0.0~5.0。Pos、Vel、Torque 分别预设为±12.5、±30、±10，这三个参数可以根据电机的实际参数进行调整。但发送控制命令时，一定要与设定值保持致，否则会控制命令会发生等比例缩放。</p>
<p><strong>下图是电机MIT模式的控制框图</strong></p>
<div align="center">  
<img src="MIT模式控制框图.png" width="600"/> 
</div>
MIT模式可实现力矩、位置、速度三者混合控制，在上图中，位置环与速度环是并联形式，这里的位置环与速度环的输出值与前馈力矩t_ff相加得到参考力矩T_ref：
<div align="center">  
<img src="力矩计算公式.png" width="600"/> 
</div>
其中:<br> 
T_ref 为参考力矩，单位是 N·m。 <br>  
kp 为位置增益。kd 为速度增益。  <br> 
p_des 为电机输出轴的期望位置，单位为 rad。  <br> 
θm 为电机输出轴的当前位置，单位为 rad。  <br> 
v_des 为电机输出轴的期望速度，单位为 rad/s。<br> 
为电机输出轴的当前速度，单位为 rad/s。   <br> 
参考力矩 T_ref 经过 KT_OUT 换算，得到参考电流 iqref，从而进入后续的电流 PI 控制器。<br>   
其中：
<div align="center">  
<img src="iqrf.png" width="600"/> 
</div>
<p>iqref 为参考电流，单位为 A。<br>
GR 为电机减速比。<br>
Kt 为减速前的转矩常数，单位是 N·m/A。<br>
NPP 是极对数。<br>
flux 磁链，单位是 Wb，可以通过读电机参数得出。<br></p>
<p><strong>根据厂家的通信协议，每次发送指令后会有反馈帧，对反馈帧处理可得到包括电机ID、状态、位置、速度、扭矩相关温度参数、寄存器数据等。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/**
</span></span><span class="line"><span class="cl">************************************************************************
</span></span><span class="line"><span class="cl">* @brief:      	dm4310_fbdata: 获取DM4310电机反馈数据函数
</span></span><span class="line"><span class="cl">* @param[in]:   motor:    指向motor_t结构的指针，包含电机相关信息和反馈数据
</span></span><span class="line"><span class="cl">* @param[in]:   rx_data:  指向包含反馈数据的数组指针
</span></span><span class="line"><span class="cl">* @param[in]:   data_len: 数据长度
</span></span><span class="line"><span class="cl">* @retval:     	void
</span></span><span class="line"><span class="cl">* @details:    	从接收到的数据中提取DM4310电机的反馈信息，包括电机ID、
</span></span><span class="line"><span class="cl">*               状态、位置、速度、扭矩相关温度参数、寄存器数据等
</span></span><span class="line"><span class="cl">************************************************************************
</span></span><span class="line"><span class="cl">**/
</span></span><span class="line"><span class="cl">void dm4310_fbdata(Joint_Motor_t *motor, uint8_t *rx_data,uint32_t data_len)
</span></span><span class="line"><span class="cl">{ 
</span></span><span class="line"><span class="cl">	if(data_len==FDCAN_DLC_BYTES_8)
</span></span><span class="line"><span class="cl">	{//返回的数据有8个字节
</span></span><span class="line"><span class="cl">	  motor-&gt;para.id = (rx_data[0])&amp;0x0F;
</span></span><span class="line"><span class="cl">	  motor-&gt;para.state = (rx_data[0])&gt;&gt;4;
</span></span><span class="line"><span class="cl">	  motor-&gt;para.p_int=(rx_data[1]&lt;&lt;8)|rx_data[2];
</span></span><span class="line"><span class="cl">	  motor-&gt;para.v_int=(rx_data[3]&lt;&lt;4)|(rx_data[4]&gt;&gt;4);
</span></span><span class="line"><span class="cl">	  motor-&gt;para.t_int=((rx_data[4]&amp;0xF)&lt;&lt;8)|rx_data[5];
</span></span><span class="line"><span class="cl">	  motor-&gt;para.pos = uint_to_float(motor-&gt;para.p_int, P_MIN, P_MAX, 16); // (-12.5,12.5)
</span></span><span class="line"><span class="cl">	  motor-&gt;para.vel = uint_to_float(motor-&gt;para.v_int, V_MIN, V_MAX, 12); // (-30.0,30.0)
</span></span><span class="line"><span class="cl">	  motor-&gt;para.tor = uint_to_float(motor-&gt;para.t_int, T_MIN, T_MAX, 12);  // (-10.0,10.0)
</span></span><span class="line"><span class="cl">	  motor-&gt;para.Tmos = (float)(rx_data[6]);
</span></span><span class="line"><span class="cl">	  motor-&gt;para.Tcoil = (float)(rx_data[7]);
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>再下一层就是stm32hal库的can初始化和发送接收函数了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">void MX_FDCAN1_Init(void)
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">uint8_t canx_send_data(FDCAN_HandleTypeDef *hcan, uint16_t id, uint8_t *data, uint32_t len)
</span></span><span class="line"><span class="cl">....
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2小车直立">2、小车直立</h3>
<h4 id="lqr和pid控制算法的对比">LQR和PID控制算法的对比</h4>
<p><strong>对比如下表（摘自网络）。</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">特性</th>
<th style="text-align:left">LQR</th>
<th style="text-align:left">PID</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">控制对象</td>
<td style="text-align:left">多变量耦合系统（如小车角度+位置）</td>
<td style="text-align:left">单变量系统（如水温）</td>
</tr>
<tr>
<td style="text-align:left">设计原理</td>
<td style="text-align:left">基于数学模型优化（解 Riccati 方程）</td>
<td style="text-align:left">基于误差经验调参</td>
</tr>
<tr>
<td style="text-align:left">核心优势</td>
<td style="text-align:left">全局最优 • 多状态自动协调</td>
<td style="text-align:left">简单易用 • 无需模型</td>
</tr>
<tr>
<td style="text-align:left">参数调整</td>
<td style="text-align:left">调权重矩阵（Q/R）</td>
<td style="text-align:left">调三个系数（Kp/Ki/Kd）</td>
</tr>
<tr>
<td style="text-align:left">抗干扰能力</td>
<td style="text-align:left">✅ 更强（通过状态权重主动抑制）</td>
<td style="text-align:left">❌ 高频噪声易放大</td>
</tr>
<tr>
<td style="text-align:left">适用系统</td>
<td style="text-align:left">线性系统 • 精确建模场景</td>
<td style="text-align:left">非线性系统 • 模型未知场景</td>
</tr>
<tr>
<td style="text-align:left">计算复杂度</td>
<td style="text-align:left">离线计算复杂 • 在线计算简单</td>
<td style="text-align:left">全程计算简单</td>
</tr>
<tr>
<td style="text-align:left">典型应用</td>
<td style="text-align:left">倒立摆 • 无人机 • 机械臂</td>
<td style="text-align:left">温控 • 液位控制 • 电机调速</td>
</tr>
</tbody>
</table></div>
<p>这里直立算法选择用LQR，后面有时间也会出一版PID的程序。</p>
<h4 id="lqr数学模型">LQR数学模型</h4>
<div align="center">  
<img src="car.png" width="600"/> 
</div>
<p><strong>运动学</strong><br>
运动学模型主要描述两轮自平衡机器人运动速度、转向和左右两轮速度之间的关系。</p>
<p><strong>动力学</strong><br>
a.对于车轮<br>
针对右轮进行受力分析</p>
<div align="center">  
<img src="右轮受力分析.png" width="300"/> 
</div>
车轮的运动可分解为平动和转动，则由牛顿第二定律可得：
<div align="center">  
<img src="公式1.png" width="600"/> 
</div>
由刚体定轴转动定律可得
<div align="center">  
<img src="公式2.png" width="600"/> 
</div>
上式（1）（2）中   <br>
m为车轮的质量（kg）；<br>
r为车轮的半径（m）；<br>
xR为右轮水平位移（m）；<br>
HfR为右轮受到地面摩擦力的大小（N）；<br>
HR为右轮受到车体作用力的水平分力的大小（N）；<br>
TR为右轮电机输出转矩的大小（N/m）；<br>
I为车轮的转动惯量（kg/m2）；<br>
WR为右轮的角度的大小（rad/s）<br>
<br>
联立（1）和（2），消去HfR,可得<br>
<div align="center">  
<img src="公式3.png" width="600"/> 
</div>
<p>在车轮不打滑的情况下，车轮移动速度的大小和转动速度的大小成比例关系，即</p>
<div align="center">  
<img src="公式4.png" width="600"/> 
</div>
<p>将方程（4）代入（3）中，可得</p>
<div align="center">  
<img src="公式5.png" width="600"/> 
</div>
<p>由于左右轮的参数相同，则对左轮也可以得到相似的结果，即</p>
<div align="center">  
<img src="公式6.png" width="600"/> 
</div>
<p>b.对于车身正向</p>
<div align="center">  
<img src="车身正向受力分析.png" width="300"/> 
</div>
<p>小车的正向运动可以分解为前向运动和绕车体质心P的相对转动（俯仰）。小车底盘中心O的水平位移</p>
<div align="center">  
<img src="公式7.png" width="600"/> 
</div>
<p>将方程（5）和（6）相加后，等式两边处以2可得</p>
<div align="center">  
<img src="公式8.png" width="600"/> 
</div>
<p>联立方程（7）（8）可得</p>
<div align="center">  
<img src="公式9.png" width="600"/> 
</div>
<p>对车体，由牛顿第二定律可得
在水平方向上，有</p>
<div align="center">  
<img src="公式10.png" width="600"/> 
</div>
<p>在竖直方向上，有</p>
<div align="center">  
<img src="公式11.png" width="600"/> 
</div>
<p>对车体，由刚体定轴转动定律可得</p>
<div align="center">  
<img src="公式12.png" width="600"/> 
</div>
<p>其中<br>
M 车体的质量（kg）；<br>
l 质心距底盘中心的距离（m）；<br>
JP 车体绕质心转动时的转动惯量（kg/m2）；<br>
θP车体与竖直方向所成的夹角（rad）；</p>
<p>联立方程（9）（10）可得</p>
<div align="center">  
<img src="公式13.png" width="600"/> 
</div>
<br>
c.模型线性化<br>
因为该方程含有非线性项，因此，要进行线性化。考虑到车体的倾角比较小（通常情况下，−10°≤倾角≤10°），则可以认为
<div align="center">  
<img src="模型线性化.png" width="600"/> 
</div>
<p>故方程（13）变为</p>
<div align="center">  
<img src="公式14.png" width="600"/> 
</div>
<p>将方程（10）和（11）代入方程（12）中，可得</p>
<div align="center">  
<img src="公式15.png" width="600"/> 
</div>
<p>类似的，对方程 （15）进行线性化可得</p>
<div align="center">  
<img src="公式16.png" width="600"/> 
</div>
<p>将方程（16）代入方程（14）中，消去θP二阶导可得</p>
<div align="center">  
<img src="公式17.png" width="600"/> 
</div>
式中
<div align="center">  
<img src="公式17（2）.png" width="600"/> 
</div>
<p>将方程（14）代入方程（16）中，消去x二阶导可得</p>
<div align="center">  
<img src="公式18.png" width="600"/> 
</div>
式中
<div align="center">  
<img src="公式18（2）.png" width="600"/> 
</div>
<p>综上所述，对于正向运动有</p>
<div align="center">  
<img src="公式19.png" width="600"/> 
</div>
<p>对车体，由刚体定轴转动定律可得</p>
<div align="center">  
<img src="公式12.png" width="600"/> 
</div>
<br>
d.转向运动<br>
<div align="center">  
<img src="转向运动受力分析.png" width="300"/> 
</div>
转向运动是由于左右两车轮从水平方向上施加给车体的反作用力的大小HL和HR不相等引起的，则由刚体定轴转动定律可得
<div align="center">  
<img src="公式20.png" width="600"/> 
</div>
<p>其中<br>
d 轮距（m）<br>
Jδ 车体绕y轴转动的转动惯量（kg/）<br>
δ 小车的偏航角（rad）<br>
将方程（5）和（6）相减可得<br>
对车体，由刚体定轴转动定律可得<br></p>
<div align="center">  
<img src="公式21.png" width="600"/> 
</div>
<p>小车转向示意图</p>
<div align="center">  
<img src="小车转向示意图.png" width="300"/> 
</div>
<p>当左右两轮运动速度不相等时，小车身转向，如图 2-4 所示。由几何关系可得</p>
<div align="center">  
<img src="公式22.png" width="600"/> 
</div>
<p>解得</p>
<div align="center">  
<img src="公式23.png" width="600"/> 
</div>
<p>由方程（23）进一步可得</p>
<div align="center">  
<img src="公式24.png" width="600"/> 
</div>
<p>联立方程（20）（21）（24）可得</p>
<div align="center">  
<img src="公式25.png" width="600"/> 
</div>
<p>由方程（19）和（25）可得系统的状态方程为</p>
<div align="center">  
<img src="公式26.png" width="600"/> 
</div>
<p>左侧的状态变量分别表示小车的位移、前进速度、车体的倾角、车体的角速度、小车的转向角以及转向速度。由于电机输出转矩的大小不好直接控制，则由刚体定轴转动定律将其转化为两个车轮的加速度。</p>
<div align="center">  
<img src="公式27.png" width="600"/> 
</div>
<p>其中<br>
VLO左轮无摩擦时线速度的大小（rad/s）<br>
VRO右轮无摩擦时线速度的大小（rad/s）<br>
故系统的状态空间表达式变为<br></p>
<div align="center">  
<img src="公式28.png" width="600"/> 
</div>
<div align="center">  
<img src="公式28（2）.png" width="600"/> 
</div>
矩阵中的元素为
<div align="center">  
<img src="公式28（3）.png" width="600"/> 
</div>
其中
<div align="center">  
<img src="公式28（4）.png" width="600"/> 
</div>
<h4 id="lqr控制器">LQR控制器</h4>
<div align="center">  
<img src="线性二次调节器.png" width="600"/> 
</div>
<p><strong>最优控制</strong>在现代控制理论中有着及其重要的位置，其研究目标是使受控系统的性能指标达到最优时，所需要的基本条件，及其控制的综合方法。
<strong>线性二次型（LQR）控制</strong>，是一种线性状态反馈控制方法，是最优控制理
论中最成熟、最系统的方法。</p>
<p>(1)系统状态方程</p>
<div align="center">  
<img src="公式119.png" width="600"/> 
</div>
<p>(2)性能指标</p>
<div align="center">  
<img src="公式120.png" width="600"/> 
</div>
<p>(3)反馈增益矩阵K</p>
<div align="center">  
<img src="公式30.png" width="600"/> 
</div>
<p>(4)Riccati代数方程</p>
<div align="center">  
<img src="公式123.png" width="600"/> 
</div>
<h4 id="仿真">仿真</h4>
<p>(1)Simulink模型</p>
<div align="center">  
<img src="Simulink模型.png" width="600"/> 
</div>
<p>(2)MATLAB代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">clc
</span></span><span class="line"><span class="cl">clear
</span></span><span class="line"><span class="cl">% 模型参数初始化
</span></span><span class="line"><span class="cl">m=0.178; %车轮的质量 kg
</span></span><span class="line"><span class="cl">r = 0.03375; %车轮的半径 m
</span></span><span class="line"><span class="cl">M = 0.610; %车体的质量 kg
</span></span><span class="line"><span class="cl">I = 0.5*m*r^2; %车轮的转动惯量
</span></span><span class="line"><span class="cl">l = 0.055; %质心距底盘中心的距离
</span></span><span class="line"><span class="cl">Jz = (1/3)*M*l*l; %车体绕质心转动时的转动惯量
</span></span><span class="line"><span class="cl">g=9.8;                     %重力加速度，单位为m/s^2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">%状态空间参数初始化
</span></span><span class="line"><span class="cl">a=r*(M+2*m+2*I/(r^2));
</span></span><span class="line"><span class="cl">b=M*r*l;
</span></span><span class="line"><span class="cl">c=Jz+M*l^2;
</span></span><span class="line"><span class="cl">d=M*g*l;
</span></span><span class="line"><span class="cl">e=M*l;
</span></span><span class="line"><span class="cl">A23=-b*d/(a*c-b*e);
</span></span><span class="line"><span class="cl">A43=a*d/(a*c-b*e);
</span></span><span class="line"><span class="cl">B21=(c+b)/(a*c-b*e);
</span></span><span class="line"><span class="cl">B22=(c+b)/(a*c-b*e);
</span></span><span class="line"><span class="cl">B41=-(e+a)/(a*c-b*e);
</span></span><span class="line"><span class="cl">B42=-(e+a)/(a*c-b*e);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">%状态空间矩阵
</span></span><span class="line"><span class="cl">A=[0 1  0  0 ;
</span></span><span class="line"><span class="cl">   0 0 A23 0 ;
</span></span><span class="line"><span class="cl">   0 0  0  1;
</span></span><span class="line"><span class="cl">   0 0 A43 0 ]  ;                      %状态矩阵
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">B=[0 0;
</span></span><span class="line"><span class="cl">    B21 B22;
</span></span><span class="line"><span class="cl">    0 0;
</span></span><span class="line"><span class="cl">    B41 B42];     %输入矩阵
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">%系统可控性判断
</span></span><span class="line"><span class="cl">Co=ctrb(A,B);
</span></span><span class="line"><span class="cl">if(rank(Co)==4)
</span></span><span class="line"><span class="cl">    disp(&#39;系统可控&#39;);
</span></span><span class="line"><span class="cl">else
</span></span><span class="line"><span class="cl">    disp(&#39;系统不可控&#39;);
</span></span><span class="line"><span class="cl">end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">%LQR控制器设计
</span></span><span class="line"><span class="cl">  Q = [0.1 0  0    0 ;
</span></span><span class="line"><span class="cl">         0   1 0   0 ; 
</span></span><span class="line"><span class="cl">         0   0 70 0 ; 
</span></span><span class="line"><span class="cl">         0   0  0    0.05 ]; %权重矩阵 Q 的设计
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    R = [120 0; 0 120]; %权重矩阵 R 的设计
</span></span><span class="line"><span class="cl">K=lqr(A,B,Q,R)                         %调节参数
</span></span></code></pre></td></tr></table>
</div>
</div><p>(3)python代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import numpy as np
</span></span><span class="line"><span class="cl">import control as ctrl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 模型参数初始化
</span></span><span class="line"><span class="cl">m = 0.178  # 车轮的质量 kg
</span></span><span class="line"><span class="cl">r = 0.03375  # 车轮的半径 m
</span></span><span class="line"><span class="cl">M = 0.610  # 车体的质量 kg
</span></span><span class="line"><span class="cl">I = 0.5 * m * r**2  # 车轮的转动惯量
</span></span><span class="line"><span class="cl">l = 0.055  # 质心距底盘中心的距离
</span></span><span class="line"><span class="cl">Jz = (1/3) * M * l * l  # 车体绕质心转动时的转动惯量
</span></span><span class="line"><span class="cl">g = 9.8  # 重力加速度 m/s²
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 状态空间参数计算
</span></span><span class="line"><span class="cl">a = r * (M + 2*m + 2*I/(r**2))
</span></span><span class="line"><span class="cl">b = M * r * l
</span></span><span class="line"><span class="cl">c = Jz + M * l**2
</span></span><span class="line"><span class="cl">d = M * g * l
</span></span><span class="line"><span class="cl">e = M * l
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 计算中间参数
</span></span><span class="line"><span class="cl">denominator = a*c - b*e  # 公共分母
</span></span><span class="line"><span class="cl">A23 = -b*d / denominator
</span></span><span class="line"><span class="cl">A43 = a*d / denominator
</span></span><span class="line"><span class="cl">B21 = (c + b) / denominator
</span></span><span class="line"><span class="cl">B22 = B21  # 与 B21 相同
</span></span><span class="line"><span class="cl">B41 = -(e + a) / denominator
</span></span><span class="line"><span class="cl">B42 = B41  # 与 B41 相同
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 构建状态空间矩阵
</span></span><span class="line"><span class="cl">A = np.array([
</span></span><span class="line"><span class="cl">    [0, 1, 0, 0],
</span></span><span class="line"><span class="cl">    [0, 0, A23, 0],
</span></span><span class="line"><span class="cl">    [0, 0, 0, 1],
</span></span><span class="line"><span class="cl">    [0, 0, A43, 0]
</span></span><span class="line"><span class="cl">])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">B = np.array([
</span></span><span class="line"><span class="cl">    [0, 0],
</span></span><span class="line"><span class="cl">    [B21, B22],
</span></span><span class="line"><span class="cl">    [0, 0],
</span></span><span class="line"><span class="cl">    [B41, B42]
</span></span><span class="line"><span class="cl">])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 检查系统可控性
</span></span><span class="line"><span class="cl">Co = ctrl.ctrb(A, B)
</span></span><span class="line"><span class="cl">rank = np.linalg.matrix_rank(Co)
</span></span><span class="line"><span class="cl">print(&#34;系统可控&#34; if rank == 4 else &#34;系统不可控&#34;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># LQR控制器设计
</span></span><span class="line"><span class="cl">Q = np.array([
</span></span><span class="line"><span class="cl">    [0.1, 0, 0, 0],
</span></span><span class="line"><span class="cl">    [0, 1, 0, 0],
</span></span><span class="line"><span class="cl">    [0, 0, 70, 0],
</span></span><span class="line"><span class="cl">    [0, 0, 0, 0.05]
</span></span><span class="line"><span class="cl">])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">R = np.array([
</span></span><span class="line"><span class="cl">    [120, 0],
</span></span><span class="line"><span class="cl">    [0, 120]
</span></span><span class="line"><span class="cl">])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 计算LQR增益
</span></span><span class="line"><span class="cl">K, _, _ = ctrl.lqr(A, B, Q, R)
</span></span><span class="line"><span class="cl">print(&#34;\nLQR增益矩阵 K:&#34;)
</span></span><span class="line"><span class="cl">print(K)
</span></span></code></pre></td></tr></table>
</div>
</div><p>(4)实验结果</p>
<div align="center">  
<img src="仿真结果.png" width="400"/> 
</div>
<p>核心是调节Q/R矩阵的4个权重值（位置/速度/角度/角速度)<br>
角度权重 &raquo; 位置权重 (通常10倍以上)</p>
<h4 id="参考资料">参考资料</h4>
<p><a class="link" href="https://blog.csdn.net/qq_42681425/article/details/147955308?sharetype=blogdetail&amp;shareId=147955308&amp;sharerefer=APP&amp;sharesource=xiumabao0646&amp;sharefrom=link"  target="_blank" rel="noopener"
    >【电机仿真】LQR控制器——二轮平衡小车控制</a></p>
<p><a class="link" href="https://www.eet-china.com/mp/a44309.html"  target="_blank" rel="noopener"
    >超详细!!双轮平衡小车原理分析,文末附STM32源码!</a></p>
<h4 id="实物部署">实物部署</h4>
<p>通过LQR矩阵分别与对应的数值差计算再累加，可得出电机的力矩大小，如果只是直立的话，只计算其中一个力矩，另外一个数值即等大反向。<br>
将程序烧录到小车上后可观察出力矩方向看是否正负反了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">float lqr_k[2][4]={{-0.02041241, -0.09635536, -0.65913956, -0.03197374},
</span></span><span class="line"><span class="cl"> {-0.02041241, -0.09635536, -0.65913956, -0.03197374}};
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">void ChassisR_task(void)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	while(INS.ins_flag==0)
</span></span><span class="line"><span class="cl">	{//等待加速度收敛
</span></span><span class="line"><span class="cl">	  osDelay(1);	
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ChassisR_init(&amp;chassis_move);
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	while(1)
</span></span><span class="line"><span class="cl">	{	
</span></span><span class="line"><span class="cl">		chassisR_feedback_update(&amp;chassis_move,&amp;INS);//更新数据
</span></span><span class="line"><span class="cl">							
</span></span><span class="line"><span class="cl">    	chassis_move.wheel_motor[1].wheel_T=lqr_k[0][0]*(chassis_move.x_set-chassis_move.x)
</span></span><span class="line"><span class="cl">						+lqr_k[0][1]*(chassis_move.v_set-chassis_move.v)
</span></span><span class="line"><span class="cl">						+lqr_k[0][2]*(0.03f-chassis_move.myPithR)//0.03rad是机械中值
</span></span><span class="line"><span class="cl">						+lqr_k[0][3]*(chassis_move.d_phi_set-chassis_move.myPithGyroR);
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		chassis_move.wheel_motor[0].wheel_T=-chassis_move.wheel_motor[1].wheel_T;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		scaled_down(&amp;chassis_move.wheel_motor[0].wheel_T, &amp;chassis_move.wheel_motor[1].wheel_T,-0.1f,0.1f); //限幅，等比例缩放 
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		if(chassis_move.start_flag==1)	
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x01, 0.0f, 0.0f,0.0f, 0.0f,chassis_move.wheel_motor[0].wheel_T);//左边电机
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x02, 0.0f, 0.0f,0.0f, 0.0f,chassis_move.wheel_motor[1].wheel_T);//右边电机
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		else if(chassis_move.start_flag==0)	
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			chassis_move.turn_set=chassis_move.total_yaw;
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x01, 0.0f, 0.0f,0.0f, 0.0f,0.0f);//左边电机	
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x02, 0.0f, 0.0f,0.0f, 0.0f,0.0f);//右边电机	
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">} 
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的程序中计算出力矩后还是进行了限幅的操作，防止力矩过大。<br>
小车成功直立后可微调K矩阵让效果更好</p>
<h3 id="3小车遥控">3、小车遥控</h3>
<p><strong>硬件及遥控数据接收程序</strong></p>
<p>小车遥控的接收板选用的是带蓝牙wifi的wsp32，既可以实现2.4g网络遥控，也可以通过蓝牙遥控，价格也不比单独的蓝牙模块贵。<br>
手柄选用的是国产xbox系列的，刚好github上有网友分享了<a class="link" href="https://github.com/xiaocainiao11111/ESP32_connect_XboxController"  target="_blank" rel="noopener"
    >xbox+esp32的程序</a>，稍微改下即可使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">void loop()
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  xboxController.onLoop();
</span></span><span class="line"><span class="cl">  delay(50);# 控制发送频率
</span></span><span class="line"><span class="cl">  if ((xboxController.xboxNotif.btnStart == 1) &amp;&amp; (last_start != xboxController.xboxNotif.btnStart))
</span></span><span class="line"><span class="cl">    if (start == 0)
</span></span><span class="line"><span class="cl">      start = 1;
</span></span><span class="line"><span class="cl">    else
</span></span><span class="line"><span class="cl">      start = 0;
</span></span><span class="line"><span class="cl">  last_start = xboxController.xboxNotif.btnStart;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  if (xboxController.isConnected() &amp;&amp; (start == 1))
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    if (xboxController.isWaitingForFirstNotification())
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">      Serial.println(&#34;waiting for first notification&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    else
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">      Serial.print(xbox_string());
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  else if (!xboxController.isConnected() &amp;&amp; (start == 1))
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    Serial.println(&#34;not connected&#34;);
</span></span><span class="line"><span class="cl">    if (xboxController.getCountFailedConnection() &gt; 2)
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">      ESP.restart();
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我这里改的地方是增加延时来控制发送频率，另外增加了按键来控制是否发送手柄数据到串口。</p>
<p>最后增加个freertos的任务专门处理手柄数据即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">void Xbox_task(void)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    if (esp32_rx_flag)
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        // 清除接收完成标志
</span></span><span class="line"><span class="cl">        esp32_rx_flag = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 确保数据结尾有换行符
</span></span><span class="line"><span class="cl">        if (esp32_rx_len &gt; 0 &amp;&amp; esp32_rx_buffer[esp32_rx_len - 1] == &#39;\n&#39;)
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl">            // 复制数据到临时缓冲区，并添加字符串结束符
</span></span><span class="line"><span class="cl">            char temp_buffer[ESP32_RX_BUFFER_SIZE];
</span></span><span class="line"><span class="cl">            // 排除 &#39;\n&#39;，只复制中间的数据部分
</span></span><span class="line"><span class="cl">            strncpy(temp_buffer, (char*)esp32_rx_buffer, esp32_rx_len - 1);
</span></span><span class="line"><span class="cl">            temp_buffer[esp32_rx_len - 1] = &#39;\0&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            char *token;
</span></span><span class="line"><span class="cl">            char *rest = temp_buffer;
</span></span><span class="line"><span class="cl">            int data_index = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            // 解析所有22个数据
</span></span><span class="line"><span class="cl">            while ((token = strtok_r(rest, &#34;,&#34;, &amp;rest)) != NULL)
</span></span><span class="line"><span class="cl">            {
</span></span><span class="line"><span class="cl">                switch (data_index)
</span></span><span class="line"><span class="cl">                {
</span></span><span class="line"><span class="cl">                    case 0: xbox_controller_data.btnY = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 1: xbox_controller_data.btnX = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 2: xbox_controller_data.btnB = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 3: xbox_controller_data.btnA = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 4: xbox_controller_data.btnLB = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 5: xbox_controller_data.btnRB = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 6: xbox_controller_data.btnSelect = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 7: xbox_controller_data.btnStart = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 8: xbox_controller_data.btnXbox = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 9: xbox_controller_data.btnShare = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 10: xbox_controller_data.btnLS = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 11: xbox_controller_data.btnRS = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 12: xbox_controller_data.btnDirUp = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 13: xbox_controller_data.btnDirRight = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 14: xbox_controller_data.btnDirDown = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 15: xbox_controller_data.btnDirLeft = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 16: xbox_controller_data.joyLHori = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 17: xbox_controller_data.joyLVert = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 18: xbox_controller_data.joyRHori = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 19: xbox_controller_data.joyRVert = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 20: xbox_controller_data.trigLT = atoi(token); break;
</span></span><span class="line"><span class="cl">                    case 21: xbox_controller_data.trigRT = atoi(token); break;
</span></span><span class="line"><span class="cl">                    default: break;
</span></span><span class="line"><span class="cl">                }
</span></span><span class="line"><span class="cl">                data_index++;
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		if(xbox_controller_data.btnY == 1 &amp;&amp; start_flag == 0)
</span></span><span class="line"><span class="cl">		{//启动
</span></span><span class="line"><span class="cl">			chassis_move.start_flag=1;
</span></span><span class="line"><span class="cl">			start_flag = 1;
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		else if(xbox_controller_data.btnY == 1 &amp;&amp; start_flag == 1)
</span></span><span class="line"><span class="cl">		{//停止
</span></span><span class="line"><span class="cl">			chassis_move.start_flag=0;
</span></span><span class="line"><span class="cl">			start_flag = 0;
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		if(chassis_move.start_flag==1)
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			if(xbox_controller_data.btnB == 1 &amp;&amp; pause_flag == 0)
</span></span><span class="line"><span class="cl">			{//暂停
</span></span><span class="line"><span class="cl">				chassis_move.front_flag=0;
</span></span><span class="line"><span class="cl">				chassis_move.turn_flag=0;
</span></span><span class="line"><span class="cl">				chassis_move.v_set=0.0f;
</span></span><span class="line"><span class="cl">				chassis_move.turn_set=chassis_move.total_yaw;
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnDirUp == 1)
</span></span><span class="line"><span class="cl">			{//前进
</span></span><span class="line"><span class="cl">				chassis_move.front_flag=1;
</span></span><span class="line"><span class="cl">				chassis_move.v_set=5.0f*vel_ratio;
</span></span><span class="line"><span class="cl">				chassis_move.x_set=chassis_move.x_set+chassis_move.v_set*0.02f;				
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnDirDown == 1)
</span></span><span class="line"><span class="cl">			{//后退
</span></span><span class="line"><span class="cl">				chassis_move.front_flag=1;
</span></span><span class="line"><span class="cl">				chassis_move.v_set=-5.0f*vel_ratio;
</span></span><span class="line"><span class="cl">				chassis_move.x_set=chassis_move.x_set+chassis_move.v_set*0.02f;				
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnDirLeft == 1)
</span></span><span class="line"><span class="cl">			{//左转
</span></span><span class="line"><span class="cl">				chassis_move.turn_flag=1;
</span></span><span class="line"><span class="cl">				chassis_move.turn_set=10.0f*vel_ratio;
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnDirRight == 1)
</span></span><span class="line"><span class="cl">			{//右转
</span></span><span class="line"><span class="cl">				chassis_move.turn_flag=1;
</span></span><span class="line"><span class="cl">				chassis_move.turn_set=-10.0f*vel_ratio;
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnLB == 1)
</span></span><span class="line"><span class="cl">			{
</span></span><span class="line"><span class="cl">				vel_ratio-=0.05f;
</span></span><span class="line"><span class="cl">				// 将 vel_ratio 限制在 [0.2, 0.6] 范围内
</span></span><span class="line"><span class="cl">				vel_ratio=(vel_ratio &lt; 0.2f) ? 0.2f : ((vel_ratio &gt; 0.6f) ? 0.6f : vel_ratio);
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else if(xbox_controller_data.btnRB == 1)
</span></span><span class="line"><span class="cl">			{
</span></span><span class="line"><span class="cl">				vel_ratio+=0.05f;
</span></span><span class="line"><span class="cl">				// 将 vel_ratio 限制在 [0.2, 0.6] 范围内
</span></span><span class="line"><span class="cl">				vel_ratio=(vel_ratio &lt; 0.2f) ? 0.2f : ((vel_ratio &gt; 0.6f) ? 0.6f : vel_ratio);
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			else
</span></span><span class="line"><span class="cl">			{//暂停
</span></span><span class="line"><span class="cl">				chassis_move.front_flag=0;
</span></span><span class="line"><span class="cl">				chassis_move.turn_flag=0;
</span></span><span class="line"><span class="cl">				chassis_move.v_set=0.0f;
</span></span><span class="line"><span class="cl">				chassis_move.turn_set=chassis_move.total_yaw;
</span></span><span class="line"><span class="cl">			}
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			pause_flag = xbox_controller_data.btnB;
</span></span><span class="line"><span class="cl">		}	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">		osDelay(1);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>遥控数据处理程序</strong><br>
基于直立的程序进行修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">float Turn_Kp=0.03f;
</span></span><span class="line"><span class="cl">float Turn_Kd=0.12;
</span></span><span class="line"><span class="cl">//转向环
</span></span><span class="line"><span class="cl">float Turn(float Angle,float Gyro)
</span></span><span class="line"><span class="cl">{  
</span></span><span class="line"><span class="cl">	 float tor3;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	 if(chassis_move.turn_flag==1)
</span></span><span class="line"><span class="cl">	 {
</span></span><span class="line"><span class="cl">		 tor3=(chassis_move.turn_set-Gyro)*Turn_Kd;
</span></span><span class="line"><span class="cl">	 }
</span></span><span class="line"><span class="cl">	 else if(chassis_move.turn_flag==0)
</span></span><span class="line"><span class="cl">	 {
</span></span><span class="line"><span class="cl">	   tor3=Turn_Kp*(chassis_move.turn_set-Angle)-Gyro*Turn_Kd; 
</span></span><span class="line"><span class="cl">	 } 
</span></span><span class="line"><span class="cl">	 return tor3;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">void ChassisR_task(void)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">	while(INS.ins_flag==0)
</span></span><span class="line"><span class="cl">	{//等待加速度收敛
</span></span><span class="line"><span class="cl">	  osDelay(1);	
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  ChassisR_init(&amp;chassis_move);
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	while(1)
</span></span><span class="line"><span class="cl">	{	
</span></span><span class="line"><span class="cl">		chassisR_feedback_update(&amp;chassis_move,&amp;INS);//更新数据
</span></span><span class="line"><span class="cl">							
</span></span><span class="line"><span class="cl">    chassis_move.wheel_motor[0].wheel_T=lqr_k[0][0]*(chassis_move.x_set-chassis_move.x)
</span></span><span class="line"><span class="cl">								+lqr_k[0][1]*(chassis_move.v_set-chassis_move.v)
</span></span><span class="line"><span class="cl">								+lqr_k[0][2]*(0.03f-chassis_move.myPithR)//0.03rad是机械中值
</span></span><span class="line"><span class="cl">								+lqr_k[0][3]*(chassis_move.d_phi_set-chassis_move.myPithGyroR);
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		chassis_move.wheel_motor[1].wheel_T=lqr_k[1][0]*(chassis_move.x_set-chassis_move.x)
</span></span><span class="line"><span class="cl">								+lqr_k[1][1]*(chassis_move.v_set-chassis_move.v)
</span></span><span class="line"><span class="cl">								+lqr_k[1][2]*(0.03f-chassis_move.myPithR)//0.03rad是机械中值
</span></span><span class="line"><span class="cl">								+lqr_k[1][3]*(chassis_move.d_phi_set-chassis_move.myPithGyroR);
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		chassis_move.wheel_motor[0].wheel_T=0.0f-chassis_move.wheel_motor[0].wheel_T;
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		turn_T= Turn(chassis_move.total_yaw,INS.Gyro[2]);
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		chassis_move.wheel_motor[0].wheel_T=chassis_move.wheel_motor[0].wheel_T-turn_T;
</span></span><span class="line"><span class="cl">		chassis_move.wheel_motor[1].wheel_T=chassis_move.wheel_motor[1].wheel_T-turn_T;
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		scaled_down(&amp;chassis_move.wheel_motor[0].wheel_T, &amp;chassis_move.wheel_motor[1].wheel_T,-0.1f,0.1f);
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		if(chassis_move.start_flag==1)	
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x01, 0.0f, 0.0f,0.0f, 0.0f,chassis_move.wheel_motor[0].wheel_T);//左边电机
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x02, 0.0f, 0.0f,0.0f, 0.0f,chassis_move.wheel_motor[1].wheel_T);//右边电机
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">		else if(chassis_move.start_flag==0)	
</span></span><span class="line"><span class="cl">		{
</span></span><span class="line"><span class="cl">			chassis_move.turn_set=chassis_move.total_yaw;
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x01, 0.0f, 0.0f,0.0f, 0.0f,0.0f);//左边电机	
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">			mit_ctrl2(&amp;hfdcan1,0x02, 0.0f, 0.0f,0.0f, 0.0f,0.0f);//右边电机	
</span></span><span class="line"><span class="cl">			osDelay(CHASSR_TIME);
</span></span><span class="line"><span class="cl">		}
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="四调试心得">四、调试心得</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>现象</th>
<th>根本原因</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>高频抖动 (&gt;10Hz)</td>
<td>速度项权重不足</td>
<td>↑ Q<a class="link" href="%e9%80%9f%e5%ba%a6" >1</a> / ↑ Q<a class="link" href="%e8%a7%92%e9%80%9f%e5%ba%a6" >3</a></td>
</tr>
<tr>
<td>低频摇摆 (0.5~2Hz)</td>
<td>R值过大或位置权重过高</td>
<td>↓ R 或 ↓ Q<a class="link" href="%e4%bd%8d%e7%bd%ae" >0</a></td>
</tr>
<tr>
<td>受扰恢复慢 (&gt;1s)</td>
<td>角度权重不足</td>
<td>↑ Q<a class="link" href="%e8%a7%92%e5%ba%a6" >2</a></td>
</tr>
<tr>
<td>电机发烫</td>
<td>R值过小</td>
<td>↑ R</td>
</tr>
<tr>
<td>位置持续漂移</td>
<td>位置权重过低</td>
<td>↑ Q[0] 同时 ↑ R 防抖</td>
</tr>
</tbody>
</table></div>
<h2 id="五实物展示">五、实物展示</h2>
<p>实物中为方便调试加入了lcd显示屏和无线仿真器，并将外观做成了类似小米9号平衡车的样子。






    


<div class="video-wrapper">
    <iframe src="https://player.bilibili.com/player.html?as_wide=1&amp;high_quality=1&amp;page=1&bvid=BV1ERuzzHEXi"
            scrolling="no"
            frameborder="no"
            framespacing="0"
            allowfullscreen="true"
    >
    </iframe>
</div>
</p>
<p><strong>所涉及资料都已放在github，有需要可自行下载。</strong><br>
<a class="link" href="https://github.com/wenke-chen/DM-segway"  target="_blank" rel="noopener"
    >所用代码、BOM及3D文件</a>
<a class="link" href="https://github.com/wenke-chen/DM-segway"  target="_blank" rel="noopener"
    >https://github.com/wenke-chen/DM-segway</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6/">平衡小车</a>
        
            <a href="/tags/%E6%97%A0%E5%88%B7%E7%94%B5%E6%9C%BA/">无刷电机</a>
        
            <a href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/">机器人</a>
        
            <a href="/tags/stm32/">STM32</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/segway_pid/">
        
        
            <div class="article-image">
                <img src="/p/segway_pid/car.a49386605f2a900380ac564fd8294a93_huedaa8f5f72a7c1929b4fa5b365acec86_54738_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 基于无刷电机的平衡小车(PID)"
                        data-key="segway_pid" 
                        data-hash="md5-pJOGYF8qkAOArFZP2ClKkw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">基于无刷电机的平衡小车(PID)</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "wenke-chen's blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 wenke-chen&#39;s blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
